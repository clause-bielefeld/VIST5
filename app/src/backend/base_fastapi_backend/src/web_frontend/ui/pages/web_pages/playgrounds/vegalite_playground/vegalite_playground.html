<!DOCTYPE html>
<html>
  <head>
    <!--OURS -->
    <link rel="stylesheet" href="/static/ui/pages/web_pages/playgrounds/vegalite_playground/vegalite_playground.css">
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/vegalite_playground.js" type="text/javascript"></script>
    <!-- Bulma CSS framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <link rel="stylesheet" href="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/dataTables.bulma.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <!-- jQuery -->
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/jquery-3.5.1.min.js"></script>
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/jquery.dataTables.min.js"></script>
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/dataTables.bulma.min.js"></script>
    <!-- Vega Lite framework -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.13.0/build/vega.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.14.0/build/vega-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.15.0/build/vega-embed.min.js"></script>
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.js"></script>
    <!-- Image Download via dom-to-image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.js"></script>
    <!-- VOSK STT --->
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.5/dist/vosk.js"></script>
  </head>
  <body>
    <section class="section" id="mainSection">
      <div class="container"> 
        <div class="columns"> 
          <!-- TABS: solution found here: https://stackoverflow.com/questions/47591474/how-to-switch-through-tabs-in-bulma-->
          <!-- Left column --> 
          <div class="column is-3">
            <!-- CHAT CONTENT -->
            <div class="container-section">
              <div id="chat_content">
                <div class="chat-container" id="chat-container"></div>
                <div class="input-container">
                  <input type="text" class="input" id="message-input" placeholder="Type a message" autocomplete="off"> 
                  <!-- <textarea class="input" id="message-input" rows="4" placeholder="Type a message"></textarea> -->
                  <button class="button is-info" id="send-button">Send</button>
                </div>
              </div>
            </div>
          </div>
          <!-- End of left column -->
          <!-- Right column -->
          <div class="column"> 
            <div class="card"> 
              <!--<div class="card-header">
                <p class="card-header-title">Vega-Lite Visualization</p> 
              </div> -->
              <div id="map_card" class="card-content">
                <iframe id="map_iframe" width="100%" height="400"></iframe>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="tabs is-toggle" id="tabs">
                  <ul>
                      <li class="tab is-active" onclick="openTab(event,'plot_content')">
                        <a >Plot</a>
                      </li>
                      <li class="tab" onclick="openTab(event,'data_content')">
                        <a >Data</a>
                      </li>
                  <!--     <li class="tab" onclick="openTab(event,'code_content')">
                        <a >Code</a>
                      </li>  -->
                  </ul>
                </div><!--<p class="card-header-title">Vega-Lite plot_contentualization</p> -->
              </div>
              <div class="card-content">
              <!-- PLOT CONTENT -->
              <div id="plot_content" class="content-tab"></div>
              <!-- DATA CONTENT -->
              <div id="data_content" class="content-tab" style="display:none" >
                <!-- SELECTOR -->
                <p class="is-size-5">Select Data Set</p>
                <div class="select m-2">
                  <select id="data_set_selector">
                    <option>--select data set--</option>
                  </select>
                </div>
                <hr class="is-divider"> 
                <!-- DATA SCHEMA -->
                <div class="m-2"> 
                  <p class="is-size-5">Data Schema</p>
                  <p id="dataset-schema-list">date, temperature, radiation, precipitation, windspeed, wind_direction, city, longitude, latitude</p>
                </div>
                <hr class="is-divider">
                <!-- TABLE -->
                <div class="m-2">
                  <p class="is-size-5">Result Dataframe</p>
                  <div id="data-table-container" class="table-container" style="overflow: scroll; width: 900px; height: 300px;">
                    <table id="data-table" class="table is-striped is-fullwidth">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Age</th>
                          <th>City</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>John</td>
                          <td>30</td>
                          <td>New York</td>
                        </tr>
                        <tr>
                          <td>Jane</td>
                          <td>40</td>
                          <td>London</td>
                        </tr>
                      </tbody>
                      <tbody id="table-body">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- CODE CONTENT -->
              <div id="code_content" style="display:none">
                <p>
                  This is the Code <br>  
                  See the following:
                </p>
                <textarea id="spec-code"></textarea>
              </div> 
            </div>
            </div>
          </div>
          <!-- End of right column -->
                
                <!-- Few Shot Modal + activator button in right column -->
<!--                <div class="column is-3">
                  <button class="button is-primary" id="open-few-shot-modal" style="width: 80%;">Create Few-Shot Example</button> 
                    <div class="modal" id="few-shot-modal">
                      <div class="modal-background"></div>
                      <div class="modal-card">
                        <header class="modal-card-head">
                          <p class="modal-card-title">Few-shot Examples</p>
                          <button class="delete" aria-label="close" id="close-few-shot-modal"></button>
                        </header>
                        <section class="modal-card-body">
                          <p style="font-size: 1.2em; font-weight: bold;">Please provide three input-output examples:</p>
                          <p style="margin-bottom: 10px;">Provide three examples for how the dialog agent should respond in a certain situation. Input and output can be any kind of text, including code. The model will then use these examples to generate similar outputs for new inputs. Please provide each example in the format: <strong>input - output</strong>.</p>
                          <form>
                            <div class="field">
                              <label class="label">Example 1</label>
                              <div class="control">
                                <input class="input" type="text" placeholder="Input">
                              </div>
                              <div class="control">
                                <input class="input" type="text" placeholder="Output">
                              </div>
                            </div>
                            <div class="field">
                              <label class="label">Example 2</label>
                              <div class="control">
                                <input class="input" type="text" placeholder="Input">
                              </div>
                              <div class="control">
                                <input class="input" type="text" placeholder="Output">
                              </div>
                            </div>
                            <div class="field">
                              <label class="label">Example 3</label>
                              <div class="control">
                                <input class="input" type="text" placeholder="Input">
                              </div>
                              <div class="control">
                                <input class="input" type="text" placeholder="Output">
                              </div>
                            </div>
                          </form>
                        </section>
                        <footer class="modal-card-foot">
                          <button class="button is-primary" id="submit-few-shot-modal">Submit Examples</button>
                          <button class="button" id="cancel-few-shot-modal">Cancel</button>
                        </footer>
                      </div>
                    </div>
                  </div> 
              </div>  -->
          <!-- End of Few-shot Modal -->
          
        </div>
      </div>
    </section>
    <!-- Overlay button speech recognition -->
      <div class="speech_recognition_button_overlay is-flex" style="display:none;">
      <button id="speech_recognition_button" class="button is-medium is-white" style="display:none;">
        <span class="icon" style="display:none;">
          <i class="fas fa-microphone-alt" style="display:none;"></i>
        </span>
      </button>
    </div>  
    <!-- End of overlay button speech recognition -->
    <script>

      // LEAFLET IFRAME INTERACTION LOGIC: 
      const host_url =  "http://localhost:8080" // "https://nlpvisualizationevaluation.uni-jena.de" "http://localhost:8080" 
      const map_source = host_url + "/static/ui/pages/web_pages/playgrounds/vegalite_playground/map.html" // https://nlpvisualizationevaluation.uni-jena.de/static/ui/pages/web_pages/playgrounds/vegalite_playground/map.html
      const mapFrame = document.getElementById('map_iframe');
      // set the mapFrame src to the map_source
      mapFrame.src = map_source;

      // FETCH AVAILABLE DATASETS: when document is ready, fetch all available datasets from localhost:8080/get_available_datasets
      // and populate the data_set_selector with the available datasets
      $(document).ready(function() {
        $.ajax({
          url: `${host_url}/get_available_datasets`,
          type: 'GET',
          success: function(data) {
            console.log(data);
            const datasets_list = data.response.dataset_names
            let data_set_selector = document.getElementById('data_set_selector');
            for (let i = 0; i < datasets_list.length; i++) {
              let option = document.createElement('option');
              option.text = datasets_list[i];
              if (i == 0) {
                option.selected = true;
              }
              data_set_selector.add(option);
            }
            // update table state backend with the first dataset
            current_selected_data_set = "northern_european_cities.csv" //datasets_list[0];
            updateTableStateBackend(current_selected_data_set).then(response => {
              // the response contains the data set schema
              // log the response
              //console.log(response);
              // update the data set schema in the frontend
              const column_names = response.response.header_list;
              const column_types = response.response.data_types;
              const table_html = response.response.table_html;
              updateTable(column_names, table_html);
            });
          }
        });
      });
      // TABLE
      // initialize data table 
      $(document).ready(function() {
        $('#data-table').DataTable();
      });

      // DATA SETS
      // PATH TO THE DATA SETS: http://localhost:8080/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/tables/
      const data_set_selector = document.getElementById('data_set_selector');
      let current_selected_data_set;
      data_set_selector.addEventListener('change', (event) => {
        current_selected_data_set = event.target.value;
        // log the current selected data set
        console.log(current_selected_data_set);
        // update the data set in the backend 
        updateTableStateBackend(current_selected_data_set).then(response => {
          // the response contains the data set schema
          // log the response
          //console.log(response);
          // update the data set schema in the frontend
          const column_names = response.response.header_list;
          const column_types = response.response.data_types;
          const table_html = response.response.table_html;
          updateTable(column_names, table_html);
        });
      });
      // set the default data set -> this is the first one in the list, marked with the "selected" attribute
      current_selected_data_set = data_set_selector.value;

      // UPDATE DATA SET(=TABLE STATE) IN THE BACKEND
      async function updateTableStateBackend(dataset_file_name){
        try {
          // set the data set name as the text property of the request body
          const text = dataset_file_name
          const response = await fetch(`${host_url}/update_table_state`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
          });

          if(!response.ok){
            throw new Error(response.statusText)
          }
          const data = await response.json(); // data format: {response: "text"}
          return data;
        } catch (error) {
          console.error("Error:", error);
          throw error
        }
      }

      function updateTable(column_names, table_html) {
        // get the paragraph element with the id "dataset-schema-list"
        const dataset_schema_list = document.getElementById('dataset-schema-list');
        // clear the list
        dataset_schema_list.innerHTML = '';
        // iterate over the column names and append them to the paragraph by separating them with a comma
        for (let i = 0; i < column_names.length; i++) {
          dataset_schema_list.innerHTML += column_names[i] + ', ';
        }
        // remove the last comma
        dataset_schema_list.innerHTML = dataset_schema_list.innerHTML.slice(0, -2);
        // update the data table
        // get the data-table-container div and set the innerHTML to the updated table
        const result_table_container = document.getElementById("data-table-container");
        result_table_container.innerHTML = table_html;
        // get the table element within the container and add the id 'data-table'
        const result_table = result_table_container.getElementsByTagName("table")[0];
        result_table.id = "data-table";
        // remove the classes of the table
        result_table.classList.remove("dataframe");
        // remove the border attribute of the table
        result_table.removeAttribute("border");
        // get the first row in the table head and remove the style="text-align: right;" attribute
        const first_row = result_table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
        first_row.removeAttribute("style");
        // reset the DataTable on the result table
        $('#data-table').DataTable();
      }

      // VEGA LITE -> here we use the spec to render the visualization, alternative would be to use the vega lite api -> here we would just call it as a js function
      var bar_spec = {
          "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
          "description": "A simple bar chart with embedded data.",
          "data": {
              "values": 
              [
                  {"a": "A","b": 28}, {"a": "B","b": 55}, {"a": "C","b": 43},
                  {"a": "D","b": 91}, {"a": "E","b": 81}, {"a": "F","b": 53},
                  {"a": "G","b": 19}, {"a": "H","b": 87}, {"a": "I","b": 52}
              ]
          },
          "mark": "bar",
          "encoding": {
              "x": {"field": "a", "type": "ordinal"},
              "y": {"field": "b", "type": "quantitative"}
          }
      };

      bar_spec = {}
      // TESTING: set spec to earth spec to test data accessibility on server
      var plot_content_spec = bar_spec;
      // INITAL RENDERING OF THE PLOT
      plot_content_spec.width = 850;
      plot_content_spec.height = 150;
      vegaEmbed("#plot_content", bar_spec);

      // TAB LOGIC: solution found here: https://codepen.io/t7team/pen/ZowdRN
      function openTab(evt, tabName) {
          var i, x, tablinks;
          x = document.getElementsByClassName("content-tab");
          for (i = 0; i < x.length; i++) {
              x[i].style.display = "none";
          }
          tablinks = document.getElementsByClassName("tab");
          for (i = 0; i < x.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" is-active", "");
          }
          document.getElementById(tabName).style.display = "block";
          evt.currentTarget.className += " is-active";
      }

      // PLOT EDITING LOGIC: START
      function edit_code(edit_button_element)
      {
        console.log('edit button clicked');
        // Find the pre code block in the same message as the clicked button
        const message = edit_button_element.closest('.message');
        const codeBlock = message.querySelector('pre code');
    
        // Toggle the contenteditable attribute of the code block
        codeBlock.contentEditable = !codeBlock.isContentEditable;
        
        // Focus on the code block if it's editable
        if (codeBlock.isContentEditable) {
          codeBlock.focus();
        }
        
        // Change the button text to "Save" or "Edit"
        if (codeBlock.isContentEditable) {
          // Change the button text to "Save" when edit has been clicked before
          edit_button_element.textContent = 'Save';
        } else {
          // Change the button text to "Edit" when save has been clicked before
          edit_button_element.textContent = 'Edit';
          // SAVE: the content 
          // read the current code into a variable
          let edited_vega_lite_spec = codeBlock.textContent;
          // parse the current code into a json object
          let edited_vega_lite_spec_json = JSON.parse(edited_vega_lite_spec);
          edited_vega_lite_spec_json.width = 850 //"container";
          edited_vega_lite_spec_json.height = 150;
          // try to re-render the visualization, if it fails, revert the code
          try {
            vegaEmbed('#plot_content', edited_vega_lite_spec_json);
          } catch (error) {
            console.error("Error:", error);
          }
        } 
      }

      function submit_sample(submit_button_element)
      {
        console.log('submit button clicked');
        // get the message element
        const message = submit_button_element.closest('.message');
        // get the code element within the message
        const codeBlock = message.querySelector('pre code');
        // read the current code into a variable
        let edited_vega_lite_spec = codeBlock.textContent;
        console.log(edited_vega_lite_spec);
        // get the message of the user before the message with the code
        const previous_message = message.previousElementSibling;
        // get the text of the previous message which is the content of the p element
        const previous_message_text = previous_message.querySelector('p').textContent;
        console.log(previous_message_text); 
        // create the json object for sending to the backend
        let online_training_sample = {
          "user": previous_message_text,
          "assistant": edited_vega_lite_spec
        }
        // send the json object to the backend at: http://localhost:8080/add_online_training_sample
        fetch(`${host_url}/add_online_training_sample`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(online_training_sample)
        }).then(response => {
          console.log(response);
        });
      }
      // PLOT EDITING LOGIC: END

      // CHAT LOGIC: 
        // Get references to the chat container and input/send button
      const chatContainer = document.getElementById("chat-container");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");

      // Function to add a message to the chat
      function addMessage(text, isSent) {
        // Create a new message element
        const message = document.createElement("div");
        message.classList.add("message");
        if (isSent) {
          message.classList.add("sent");
        } else {
          message.classList.add("received");
        }
        // Add the message text
        message.innerHTML = `<p>${text}</p>`;
        // Add the current time
        const time = new Date().toLocaleString();
        message.innerHTML += `<p class="time">${time}</p>`;
        // Add the message to the chat container
        chatContainer.appendChild(message);
        // Scroll the chat container to the bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } 

      // Listen for the send button to be clicked
      sendButton.addEventListener("click", () => {
        // check if the message input is empty
                if (messageInput.value === "") {
          return;
        }
        // Get the message text
        const text = messageInput.value;
        // Add the message as a sent message
        addMessage(text, true);
        // Clear the message input 
        messageInput.value = "";
        // WAIT FOR BACKEND TO RESPOND
        // TYPING PLACEHOLDER: Create a placeholder element with the typing animation class
        const placeholder = document.createElement("div");
        placeholder.classList.add("message", "received", "typing-animation");
        // add the placeholder to the chat container
        chatContainer.appendChild(placeholder);
        // Scroll the chat container to the bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        // Send the message to the backend and add the response as a received message
        sendTextToBackend(text).then(data => {
          console.log(data.response.action)
          console.log(data.response.args) 
          const action = data.response.action;
          const args = data.response.args;
          let text = "";
          let parsed_spec = "";
          // check action 
          if(action == "text_response")
          {
            // check if args is not empty
            text = args[0];
          } 
          else if(action == "create_vis")
          {
            // CREATE VISUALIZATION
            text = args[0];  
            const new_vega_lite_spec = args[1]; 
            const updated_result_table = args[2];
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size 
            parsed_spec.width = 850 //"container";
            parsed_spec.height = 150;
            // set the correct data path of the spec -> updated: it delivers the data right away
            //parsed_spec.data = {"name":"weather", "url":"http://localhost:8080/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/tables/weather.csv"}
            console.log(parsed_spec);
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // turn var into string and then set value of code editor
            //spec = JSON.stringify(parsed_spec, null, 2);
            //codeMirrorEditor.setValue(spec);
            // UPDATE RESULT TABLE
            // get the data-table-container div and set the innerHTML to the updated table
            const result_table_container = document.getElementById("data-table-container");
            result_table_container.innerHTML = updated_result_table;
            // get the table element within the container and add the id 'data-table'
            const result_table = result_table_container.getElementsByTagName("table")[0];
            result_table.id = "data-table";
            // remove the classes of the table 
            result_table.classList.remove("dataframe");
            // remove the border attribute of the table
            result_table.removeAttribute("border");
            // get the first row in the table head and remove the style="text-align: right;" attribute
            const first_row = result_table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
            first_row.removeAttribute("style");
            // reset the DataTable on the result table
            $('#data-table').DataTable(); 
          }
          else if(action == "create_vega_lite" || action == "create_vega")
          {
            // CREATE VEGA LITE VISUALIZATION
            text = args[0];   
            const new_vega_lite_spec = args[1]; 
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size 
            parsed_spec.width = 850 //"container";
            parsed_spec.height = 150;
            console.log(parsed_spec);
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // 
          }
          else if(action == "update_vis")
          { 
            // UPDATE VISUALIZATION
            text = args[0];
            const new_vega_lite_spec = args[1];
            console.log(new_vega_lite_spec);
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size
            parsed_spec.width = "container";
            parsed_spec.height = 150;
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // turn var into string and then set value of code editor
            spec = JSON.stringify(parsed_spec, null, 2);
            codeMirrorEditor.setValue(spec);
          }
          // FEW SHOT ACTIONS
          else if(action == 'navigate_city')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const city_name = args[1];
            // call the function to navigate to the city page in the mapFrame
            mapFrame.contentWindow.navigateToCity(city_name);
          }
          else if(action == 'locomotion')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const locomotion_type = args[1];
            switch (locomotion_type) {
              case 'in':
                mapFrame.contentWindow.zoomIn();
                break;
              case 'out':
                mapFrame.contentWindow.zoomOut();
                break;
              case 'left':
                mapFrame.contentWindow.panLeft();
                break;
              case 'right':
                mapFrame.contentWindow.panRight();
                break;
              case 'up':
                mapFrame.contentWindow.panUp();
                break;
              case 'down':
                mapFrame.contentWindow.panDown();
                break;
              default:
                text = "Sorry, I don't know how to execute your command yet."
                break;
            }
          }
          else if(action == 'change_map_type')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const map_type = args[1];
            // call the change_map type function in iframe
            mapFrame.contentWindow.changeMapType(map_type);
          }
          else if(action == 'download_visualization')
          {
            // take out the text for the frontend
            text = args[0];
            // call the download function 
            download_visualization_as_image();
          }
          else if(action == 'marker_plot')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the list of lists of lat_lon values for the markers
            const lat_lon_list = args[1];
            // call the create_marker_plot function in the iframe
            mapFrame.contentWindow.create_marker_plot(lat_lon_list);
          }
          else if(action == 'heat_map')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the intensity map for the heatmap
            const intensity_map = args[1];
            // call the create_heat_map function in the iframe
            mapFrame.contentWindow.create_heatmap(intensity_map);
          }
          else if(action == 'flow_map')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the wind_map from the args
            const wind_map = args[1];
            // call the create_flow_map function in the iframe
            mapFrame.contentWindow.create_flow_map(wind_map);
          }
          else if(action == 'reset_map')
          {
            // take out the text for the frontend
            text = args[0];
            // call the reset_map function in the iframe
            mapFrame.contentWindow.reset_map();
          }
          // Add the response as a received message -> outdated -> we use the animation instead
          //addMessage(data.response, false);
          // change placeholder to received message 
          placeholder.classList.remove("typing-animation");
          placeholder.innerHTML = `<p>${text}</p>`;
          // if we have a create vega action, we need to add the code block
          if(action == "create_vega_lite" || action == "create_vega")
          {
              // Add the Vega Lite Code lock 
              edit_button_id = "editButton_"+ Math.random().toString(36).substr(2, 9);
              submit_button_id = "submitButton_" + Math.random().toString(36).substr(2, 9);
              // jfi: styling the background color of the code works like this: pre style="background-color: #000000"
              vega_lite_spec_string = JSON.stringify(parsed_spec, null, 2);
              placeholder.innerHTML += `
              <div class="message-body" style="padding: 2px;">
                <pre style="background-color: #f5f5f5">
                  <code class="language-javascript" style="font-size: 10px">${vega_lite_spec_string}</code>
                </pre>
                <div class="buttons mt-2">
                  <button class="button is-primary" id="${edit_button_id}" onclick="edit_code(this)">Edit</button>
                  <button class="button is-link" id="${submit_button_id}" onclick="submit_sample(this)">Submit</button>
                </div>
              </div>
              `;
              // in the placeholder find the edit button and add an event listener
              const edit_button = document.getElementById(edit_button_id);
              // add event listener to edit button
              edit_button.addEventListener('click', function() {
                // get the code element within the placeholder
                console.log('edit button clicked');
              });
              // in the placeholder find the submit button and add an event listener
              const submit_button = document.getElementById(submit_button_id);
              // add event listener to submit button
              submit_button.addEventListener('click', function() {
                // get the code element within the placeholder
                console.log('submit button clicked');
              });
          }
          // Add the current time
          const time = new Date().toLocaleString();
          placeholder.innerHTML += `<p class="time">${time}</p>`;
          // Scroll the chat container to the bottom
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      });
      // add initial message to the chat
      addMessage("Hello, I am VIST5. As a specialized visualization chatbot, I can generate visualizations from natural language descriptions, allow modifications based on your requirements, and answer any questions you may have related to your visualization.", false);

      // SEND INPUT TO BACKEND 
      async function sendTextToBackend(text) {
        try {
          const response = await fetch(`${host_url}/perceive_text`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
          });

          if(!response.ok){
            throw new Error(response.statusText) 
          }
          const data = await response.json(); // data format: {response: "text"}
          return data;
        } catch (error) {
          console.error("Error:", error);
          throw error
        }
      }
      // CHAT LOGIC: END

      // CUSTOM FUNCTIONS
      async function download_visualization_as_image() {
        const dom_element = document.getElementsByClassName('marks')[0]; // chart-wrapper
        domtoimage.toJpeg(dom_element, { quality: 0.99 })
        .then(function (dataUrl) {
            var link = document.createElement('a');
            link.download = 'export_plot.jpg';
            link.href = dataUrl;
            link.click();
        });
      }

      // call download_visualization_as_image 2 functions after site is loaded
      //setTimeout(download_visualization_as_image, 3000);

      function test_logg(myoutput)
      {
        console.log(myoutput);
      }

      // FUNCTION EVALUATOR: gets as input a string and evaluates it as a function, solution found here: https://stackoverflow.com/questions/6479236/calculate-string-value-in-javascript-not-using-eval
      function function_evaluator(function_string) {
        // try to evaluate the function
        try {
          // evaluate the function
          var function_to_evaluate = new Function('return ' + function_string)();
          // call the function
          function_to_evaluate();
        } catch (e) {
          // if the function could not be evaluated, log the error
          console.log(e);
          // update the chat with the error message
          const error_message = "Sorry, an error occured while executing your command. Please try again.";
          addMessage(error_message, false);
        }
        // OLD SOLUTION: 
        //return new Function('return ' + function_string)();
      }
      //function_evaluator('zoom_browser_in(50)'); //function_evaluator('test_logg("this is a very long test text")');
      // CUSTOM FUNCTIONS: END

      // VOSK SPEECH TO TEXT API: START
      //// solution found here: https://github.com/ccoreilly/vosk-browser
      async function init() {
          const resultsContainer = document.getElementById('recognition-result');
          //const partialContainer = document.getElementById('partial');

          const host_url = "http://localhost:8080" // https://nlpvisualizationevaluation.uni-jena.de "http://localhost:8080" 
          const model_path = host_url + "/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/vosk-model-small-en-us-0.15.tar.gz"

          //partialContainer.textContent = "Loading...";
          
          const channel = new MessageChannel();
          const model = await Vosk.createModel(model_path);
          model.registerPort(channel.port1);

          const sampleRate = 48000;
          
          const recognizer = new model.KaldiRecognizer(sampleRate);
          recognizer.setWords(true);

          // get the message-input field
          const message_input = document.getElementById('message-input');

          recognizer.on("result", (message) => {
              const result = message.result;
              console.log(JSON.stringify(result, null, 2));
              
              // set text to the message-input field
              const text = result.text;
              message_input.value = text;

              // if result is final, click the send-button 
              // get the send button
              const send_button = document.getElementById('send-button');
              // click the send button
              send_button.click();
          });
          recognizer.on("partialresult", (message) => {
              const partial = message.result.partial;
              console.log(JSON.stringify(partial, null, 2));
              // set partial text to the message-input field
              message_input.value = partial;
          });
          
          //partialContainer.textContent = "Ready";
          
          const mediaStream = await navigator.mediaDevices.getUserMedia({
              video: false,
              audio: {
                  echoCancellation: true,
                  noiseSuppression: true,
                  channelCount: 1,
                  sampleRate
              },
          });
          
          const audioContext = new AudioContext();
          await audioContext.audioWorklet.addModule(`${host_url}/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/recognizer-processor.js`)
          const recognizerProcessor = new AudioWorkletNode(audioContext, 'recognizer-processor', { channelCount: 1, numberOfInputs: 1, numberOfOutputs: 1 });
          recognizerProcessor.port.postMessage({action: 'init', recognizerId: recognizer.id}, [ channel.port2 ])
          recognizerProcessor.connect(audioContext.destination);
          
          const source = audioContext.createMediaStreamSource(mediaStream);
          source.connect(recognizerProcessor);
      }

      // create an onclick listener for the speech_recognition_button 
      let is_recording = false;
      const speech_recognition_button = document.getElementById('speech_recognition_button');
      speech_recognition_button.addEventListener('click', function() {
        // start the vosk speech recognition if it is not recording
        if(!is_recording)
        {
          // start the speech recognition
          console.log("start speech recognition");
          // change the button text
          //speech_recognition_button.innerHTML = "";
          // set the is_recording flag to true
          is_recording = true;
          // start the speech recognition
          init();
        }
        // stop the vosk speech recognition if it is recording
        else
        {
          // stop the speech recognition
          //console.log("stop speech recognition");
          // change the button text
          //speech_recognition_button.innerHTML = "";
          // set the is_recording flag to false
          is_recording = false;
        }
      });

      //// Few Shot Modal 
/*       const openFewShotModalButton = document.getElementById('open-few-shot-modal');
      const closeFewShotModalButton = document.getElementById('close-few-shot-modal');
      const cancelFewShotModalButton = document.getElementById('cancel-few-shot-modal');
      const submitFewShotModalButton = document.getElementById('submit-few-shot-modal');
      const fewShotModal = document.getElementById('few-shot-modal');

      openFewShotModalButton.addEventListener('click', () => {
        fewShotModal.classList.add('is-active');
      });

      closeFewShotModalButton.addEventListener('click', () => {
        fewShotModal.classList.remove('is-active');
      });

      cancelFewShotModalButton.addEventListener('click', () => {
        fewShotModal.classList.remove('is-active');
      });

      submitFewShotModalButton.addEventListener('click', () => {
        fewShotModal.classList.remove('is-active');
      }); */
      //// END Few Shot Modal

    </script>
</body>
</html>