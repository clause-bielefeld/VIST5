<!DOCTYPE html>
<html>
  <head>
    <!--OURS -->
    <link rel="stylesheet" href="/static/ui/pages/web_pages/playgrounds/vegalite_playground/vegalite_playground.css">
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/vegalite_playground.js" type="text/javascript"></script>
    <!-- Bulma CSS framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <link rel="stylesheet" href="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/dataTables.bulma.min.css">
    <!-- jQuery -->
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/jquery-3.5.1.min.js"></script>
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/jquery.dataTables.min.js"></script>
    <script src="/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/dataTables.bulma.min.js"></script>
    <!-- Vega Lite framework -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.13.0/build/vega.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.14.0/build/vega-lite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.15.0/build/vega-embed.min.js"></script>
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.57.0/lib/codemirror.min.js"></script>
      <!-- Image Download via dom-to-image -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.js"></script>
  </head>
  <body>
    <section class="section">
      <div class="container"> 
        <div class="columns"> 
          <!-- TABS: solution found here: https://stackoverflow.com/questions/47591474/how-to-switch-through-tabs-in-bulma-->
          <!-- Left column --> 
          <div class="column is-3">
            <!-- CHAT CONTENT -->
            <div class="container-section">
              <div id="chat_content">
                <div class="chat-container" id="chat-container"></div>
                <div class="input-container">
                  <input type="text" class="input" id="message-input" placeholder="Type a message"> 
                  <!-- <textarea class="input" id="message-input" rows="4" placeholder="Type a message"></textarea> -->
                  <button class="button is-info" id="send-button">Send</button>
                </div>
              </div>
            </div>
          </div>
          <!-- End of left column -->
          <!-- Right column -->
          <div class="column"> 
            <div class="card"> 
              <!--<div class="card-header">
                <p class="card-header-title">Vega-Lite Visualization</p>
              </div> -->
              <div id="map_card" class="card-content">
                <iframe id="map_iframe" width="100%" height="400"></iframe>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="tabs is-toggle" id="tabs">
                  <ul>
                      <li class="tab is-active" onclick="openTab(event,'plot_content')">
                        <a >Plot</a>
                      </li>
                      <li class="tab" onclick="openTab(event,'data_content')">
                        <a >Data</a>
                      </li>
                  <!--     <li class="tab" onclick="openTab(event,'code_content')">
                        <a >Code</a>
                      </li>  -->
                  </ul>
                </div><!--<p class="card-header-title">Vega-Lite plot_contentualization</p> -->
              </div>
              <div class="card-content">
              <!-- PLOT CONTENT -->
              <div id="plot_content" class="content-tab"></div>
              <!-- DATA CONTENT -->
              <div id="data_content" class="content-tab" style="display:none" >
                <!-- SELECTOR -->
                <p class="is-size-5">Select Data Set</p>
                <div class="select m-2">
                  <select id="data_set_selector">
                    <option>--select data set--</option>
                  </select>
                </div>
                <hr class="is-divider"> 
                <!-- DATA SCHEMA -->
                <div class="m-2"> 
                  <p class="is-size-5">Data Schema</p>
                  <p id="dataset-schema-list">date, temperature, radiation, precipitation, windspeed, wind_direction, city, longitude, latitude</p>
                </div>
                <hr class="is-divider">
                <!-- TABLE -->
                <div class="m-2">
                  <p class="is-size-5">Result Dataframe</p>
                  <div id="data-table-container" class="table-container" style="overflow: scroll; width: 900px; height: 300px;">
                    <table id="data-table" class="table is-striped">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Age</th>
                          <th>City</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>John</td>
                          <td>30</td>
                          <td>New York</td>
                        </tr>
                        <tr>
                          <td>Jane</td>
                          <td>40</td>
                          <td>London</td>
                        </tr>
                      </tbody>
                      <tbody id="table-body">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <!-- CODE CONTENT -->
              <div id="code_content" style="display:none">
                <p>
                  This is the Code <br>  
                  See the following:
                </p>
                <textarea id="spec-code"></textarea>
              </div> 
            </div>
            </div>
          </div>
          <!-- End of right column -->
          <!-- Task List Column -->
          <div class="column is-3">
            <ul>
              <li id="task-1">
                <article class="message is-dark">
                  <div class="message-header">
                    <p>Task 1</p>
                  </div>
                  <div class="message-body">
                    Hello World. Can we write some more text here?
                  </div>
                </article>
              </li>
              <li id="task-2">
                <article class="message is-dark">
                  <div class="message-header">
                    <p>Task 2</p>
                  </div>
                  <div class="message-body">
                    Hello World. Do this and this and that. 
                  </div>
                </article>
              </li>
              <li id="task-3"> 
                <article class="message is-dark">
                  <div class="message-header">
                    <p>Task 3</p>
                  </div>
                  <div class="message-body">
                    Hello World. And finally this and this and this and that. 
                  </div>
                </article>
              </li>
              <li id="task-4">
                <article class="message is-dark">
                  <div class="message-header">
                    <p>Free Exploration</p>
                  </div>
                  <div class="message-body">
                    Feel free to explore the tool on your own.
                  </div> 
                </article>
              </li>
              <li>
                <button class="button is-danger" id="open-finish-modal" style="width: 80%;">Finish User Study</button>
              </li>
            </ul>
          </div>
          <!-- End of Task List Column -->

          <!-- MODAL -->

          <!-- Study Start Modal -->
          <div class="modal" id="study-start-modal">
            <div class="modal-background"></div>
            <div class="modal-card">
              <header class="modal-card-head">
                <p class="modal-card-title">User Study</p>
                <button class="delete" aria-label="close" id="close-start-modal"></button>
              </header>
              <section class="modal-card-body">
                <p style="font-size: 1.2em; font-weight: bold;">Please rate the chatbot's responses:</p>
                <p style="margin-bottom: 10px;">Participate by <strong>rating the quality of the responses on a scale of 1 (bad) to 5 (very good)</strong>. After each response, simply click the number that best matches your rating.</p>
                
                <p style="font-size: 1.2em; font-weight: bold;">Leave your feedback:</p>
                <p style="margin-bottom: 10px;">If you have any additional feedback, you can <strong>leave a brief comment</strong> about the response. For example, you can type what you liked or didn't like, what you would prefer, or how the bot can improve.</p>
                
                <p style="font-size: 1.2em; font-weight: bold;">Complete the tasks:</p>
                <p style="margin-bottom: 10px;">Use the system to <strong>solve the three tasks on the right-hand side of the page sequentially</strong>. You can ask the system to provide you with charts that help you solve the task like: <strong>show me a bar chart of the average temperature per month in Berlin.</strong> After you have solved a task, help us evaluating by clicking the task so that we know that you finished it.</p><!--The system can help you answer questions like "What was the average temperature per month in Seattle in 2018?" responding with text or visualizations.</p> -->
                
                <p style="font-size: 1.2em; font-weight: bold;">Note:</p>
                <p style="margin-bottom: 10px;"> <strong>This system is designed specifically for data and visualization queries, and not general chatbot tasks, like e.g. ChatGPT.</strong></p>
                
                <p style="font-size: 1.2em; font-weight: bold;">Finish:</p>
                <p style="margin-bottom: 10px;"> After completing the tasks, click the <strong>red button on the right-hand side</strong> of the page to finish the user study. You can find a video example below. Thank you for participating!</p>
                
                <div style="margin-top: 20px;">
                  <iframe width="560" height="315" src="https://www.youtube.com/embed/opCuocRUDuo" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
              </section>
              <footer class="modal-card-foot">
                <button class="button is-primary" id="start-study-button">Start User Study</button>
                <button class="button" id="cancel-start-modal">Cancel</button>
              </footer>
            </div>
          </div>

          <!-- Study Finish Modal -->
          <div class="modal" id="study-finish-modal">
            <div class="modal-background"></div>
            <div class="modal-card">
              <header class="modal-card-head">
                <p class="modal-card-title">Finish User Study</p>
                <button class="delete" aria-label="close" id="close-finish-modal"></button>
              </header>
              <section class="modal-card-body">
                <p style="font-size: 1.2em; font-weight: bold;">Please answer the following questions before finishing:</p>
              </br>
              <div class="field">
                <label class="label">Select your gender:</label>
                <div class="control">
                  <label class="radio">
                    <input type="radio" name="gender" value="male">
                      male
                  </label>
                  <label class="radio">
                    <input type="radio" name="gender" value="female">
                    female
                  </label>
                  <label class="radio">
                    <input type="radio" name="gender" value="other">
                    other
                  </label>
                  <label class="radio">
                    <input type="radio" name="gender" value="prefer not to say">
                    prefer not to say
                  </label>
                  <!-- Add more professions as needed -->
                </div>
              </div>
                <div class="field">
                  <label class="label">Select your age group:</label>
                  <div class="control">
                    <label class="radio">
                      <input type="radio" name="age_group" value="less than 20">
                      <20
                    </label>
                    <label class="radio">
                      <input type="radio" name="age_group" value="20-30">
                      20-30
                    </label>
                    <label class="radio">
                      <input type="radio" name="age_group" value="30-40">
                      30-40
                    </label>
                    <label class="radio">
                      <input type="radio" name="age_group" value="40-50">
                      40-50
                    </label>
                    <label class="radio">
                      <input type="radio" name="age_group" value="more than 50">
                      >50
                    </label>
                    <label class="radio">
                      <input type="radio" name="age_group" value="prefer not to say">
                      prefer not to say
                    </label>
                    <!-- Add more age groups as needed -->
                  </div>
                </div>
                <div class="field">
                  <label class="label">Select your profession:</label>
                  <div class="control">
                    <label class="radio">
                      <input type="radio" name="profession" value="visualization">
                      Visualization
                    </label>
                    <label class="radio">
                      <input type="radio" name="profession" value="nlp">
                      NLP
                    </label>
                    <label class="radio">
                      <input type="radio" name="profession" value="climate science">
                      Climate Science
                    </label>
                    <label class="radio">
                      <input type="radio" name="profession" value="other">
                      Other
                    </label>
                    <label class="radio">
                      <input type="radio" name="profession" value="prefer not to say">
                      prefer not to say
                    </label>
                    <!-- Add more professions as needed -->
                  </div>
                </div>
                <div class="field">
                  <label class="label">Select your experience level in your domain:</label>
                  <div class="control">
                    <label class="radio">
                      <input type="radio" name="experience" value="less than 1 year">
                        less than 1 year
                    </label>
                    <label class="radio">
                      <input type="radio" name="experience" value="1-3 years">
                      1-3 years
                    </label>
                    <label class="radio">
                      <input type="radio" name="experience" value="3-5 years">
                      3-5 years
                    </label>
                    <label class="radio">
                      <input type="radio" name="experience" value="more than 5 years">
                      more than 5 years
                    </label>
                    <label class="radio">
                      <input type="radio" name="experience" value="prefer not to say">
                      prefer not to say 
                    </label>
                    <!-- Add more levels as needed -->
                  </div>
                </div>
              </section>
              <footer class="modal-card-foot">
                <button class="button is-primary" id="finish-study-button">Finish Study</button>
                <button class="button" id="cancel-finish-modal">Cancel</button>
              </footer>
            </div>
          </div>
          <!-- END OF MODAL -->

        </div>
      </div>
    </section>
    <script>

      // LEAFLET IFRAME INTERACTION LOGIC: 
      const host_url = "http://localhost:8080" // https://nlpvisualizationevaluation.uni-jena.de "http://localhost:8080" 
      const map_source = host_url + "/static/ui/pages/web_pages/playgrounds/vegalite_playground/map.html" // https://nlpvisualizationevaluation.uni-jena.de/static/ui/pages/web_pages/playgrounds/vegalite_playground/map.html
      const mapFrame = document.getElementById('map_iframe');
      // set the mapFrame src to the map_source
      mapFrame.src = map_source;

      // FETCH AVAILABLE DATASETS: when document is ready, fetch all available datasets from localhost:8080/get_available_datasets
      // and populate the data_set_selector with the available datasets
      $(document).ready(function() {
        $.ajax({
          url: `${host_url}/get_available_datasets`,
          type: 'GET',
          success: function(data) {
            console.log(data);
            const datasets_list = data.response.dataset_names
            let data_set_selector = document.getElementById('data_set_selector');
            for (let i = 0; i < datasets_list.length; i++) {
              let option = document.createElement('option');
              option.text = datasets_list[i];
              if (i == 0) {
                option.selected = true;
              }
              data_set_selector.add(option);
            }
            // update table state backend with the first dataset
            current_selected_data_set = "northern_european_cities.csv" //datasets_list[0];
            updateTableStateBackend(current_selected_data_set).then(response => {
              // the response contains the data set schema
              // log the response
              //console.log(response);
              // update the data set schema in the frontend
              const column_names = response.response.header_list;
              const column_types = response.response.data_types;
              const table_html = response.response.table_html;
              updateTable(column_names, table_html);
            });
          }
        });
      });
      // TABLE
      // initialize data table 
      $(document).ready(function() {
        $('#data-table').DataTable();
      });

      // DATA SETS
      // PATH TO THE DATA SETS: http://localhost:8080/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/tables/
      const data_set_selector = document.getElementById('data_set_selector');
      let current_selected_data_set;
      data_set_selector.addEventListener('change', (event) => {
        current_selected_data_set = event.target.value;
        // log the current selected data set
        console.log(current_selected_data_set);
        // update the data set in the backend 
        updateTableStateBackend(current_selected_data_set).then(response => {
          // the response contains the data set schema
          // log the response
          //console.log(response);
          // update the data set schema in the frontend
          const column_names = response.response.header_list;
          const column_types = response.response.data_types;
          const table_html = response.response.table_html;
          updateTable(column_names, table_html);
        });
      });
      // set the default data set -> this is the first one in the list, marked with the "selected" attribute
      current_selected_data_set = data_set_selector.value;


      // UPDATE DATA SET(=TABLE STATE) IN THE BACKEND
      async function updateTableStateBackend(dataset_file_name){
        try {
          // set the data set name as the text property of the request body
          const text = dataset_file_name
          const response = await fetch(`${host_url}/update_table_state`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
          });

          if(!response.ok){
            throw new Error(response.statusText)
          }
          const data = await response.json(); // data format: {response: "text"}
          return data;
        } catch (error) {
          console.error("Error:", error);
          throw error
        }
      }

      function updateTable(column_names, table_html) {
        // get the paragraph element with the id "dataset-schema-list"
        const dataset_schema_list = document.getElementById('dataset-schema-list');
        // clear the list
        dataset_schema_list.innerHTML = '';
        // iterate over the column names and append them to the paragraph by separating them with a comma
        for (let i = 0; i < column_names.length; i++) {
          dataset_schema_list.innerHTML += column_names[i] + ', ';
        }
        // remove the last comma
        dataset_schema_list.innerHTML = dataset_schema_list.innerHTML.slice(0, -2);
        // update the data table
        // get the data-table-container div and set the innerHTML to the updated table
        const result_table_container = document.getElementById("data-table-container");
        result_table_container.innerHTML = table_html;
        // get the table element within the container and add the id 'data-table'
        const result_table = result_table_container.getElementsByTagName("table")[0];
        result_table.id = "data-table";
        // remove the classes of the table
        result_table.classList.remove("dataframe");
        // remove the border attribute of the table
        result_table.removeAttribute("border");
        // get the first row in the table head and remove the style="text-align: right;" attribute
        const first_row = result_table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
        first_row.removeAttribute("style");
        // reset the DataTable on the result table
        $('#data-table').DataTable();
      }

      // VEGA LITE -> here we use the spec to render the visualization, alternative would be to use the vega lite api -> here we would just call it as a js function
      var bar_spec = {
          "$schema": "https://vega.github.io/schema/vega-lite/v4.json",
          "description": "A simple bar chart with embedded data.",
          "data": {
              "values": 
              [
                  {"a": "A","b": 28}, {"a": "B","b": 55}, {"a": "C","b": 43},
                  {"a": "D","b": 91}, {"a": "E","b": 81}, {"a": "F","b": 53},
                  {"a": "G","b": 19}, {"a": "H","b": 87}, {"a": "I","b": 52}
              ]
          },
          "mark": "bar",
          "encoding": {
              "x": {"field": "a", "type": "ordinal"},
              "y": {"field": "b", "type": "quantitative"}
          }
      };
      bar_spec = {};
      // TESTING: set spec to earth spec to test data accessibility on server
      let plot_content_spec = bar_spec;
      // INITAL RENDERING OF THE PLOT
      plot_content_spec.width = 500;
      plot_content_spec.height = 150;
      vegaEmbed("#plot_content", bar_spec);

      // TAB LOGIC: solution found here: https://codepen.io/t7team/pen/ZowdRN
      function openTab(evt, tabName) {
          var i, x, tablinks;
          x = document.getElementsByClassName("content-tab");
          for (i = 0; i < x.length; i++) {
              x[i].style.display = "none";
          }
          tablinks = document.getElementsByClassName("tab");
          for (i = 0; i < x.length; i++) {
              tablinks[i].className = tablinks[i].className.replace(" is-active", "");
          }
          document.getElementById(tabName).style.display = "block";
          evt.currentTarget.className += " is-active";
      }

      // PLOT EDITING LOGIC: START
      function edit_code(edit_button_element)
      {
        console.log('edit button clicked');
        // Find the pre code block in the same message as the clicked button
        const message = edit_button_element.closest('.message');
        const codeBlock = message.querySelector('pre code');
    
        // Toggle the contenteditable attribute of the code block
        codeBlock.contentEditable = !codeBlock.isContentEditable;
        
        // Focus on the code block if it's editable
        if (codeBlock.isContentEditable) {
          codeBlock.focus();
        }
        
        // Change the button text to "Save" or "Edit"
        if (codeBlock.isContentEditable) {
          // Change the button text to "Save" when edit has been clicked before
          edit_button_element.textContent = 'Save';
        } else {
          // Change the button text to "Edit" when save has been clicked before
          edit_button_element.textContent = 'Edit';
          // SAVE: the content 
          // read the current code into a variable
          let edited_vega_lite_spec = codeBlock.textContent;
          // parse the current code into a json object
          let edited_vega_lite_spec_json = JSON.parse(edited_vega_lite_spec);
          edited_vega_lite_spec_json.width = 500 //"container";
          edited_vega_lite_spec_json.height = 150;
          // try to re-render the visualization, if it fails, revert the code
          try {
            vegaEmbed('#plot_content', edited_vega_lite_spec_json);
          } catch (error) {
            console.error("Error:", error);
          }
        } 
      }

      function submit_sample(submit_button_element)
      {
        console.log('submit button clicked');
        // get the message element
        const message = submit_button_element.closest('.message');
        // get the code element within the message
        const codeBlock = message.querySelector('pre code');
        // read the current code into a variable
        let edited_vega_lite_spec = codeBlock.textContent;
        console.log(edited_vega_lite_spec);
        // get the message of the user before the message with the code
        const previous_message = message.previousElementSibling;
        // get the text of the previous message which is the content of the p element
        const previous_message_text = previous_message.querySelector('p').textContent;
        console.log(previous_message_text); 
        // create the json object for sending to the backend
        let online_training_sample = {
          "user": previous_message_text,
          "assistant": edited_vega_lite_spec
        }
        // send the json object to the backend at: http://localhost:8080/add_online_training_sample
        fetch(`${host_url}/add_online_training_sample`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(online_training_sample)
        }).then(response => {
          console.log(response);
        });
      }
      // PLOT EDITING LOGIC: END

      // CHAT LOGIC: 
      // Get references to the chat container and input/send button
      const chatContainer = document.getElementById("chat-container");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");

      // Function to add a message to the chat
      function addMessage(text, isSent) {
        // Create a new message element
        const message = document.createElement("div");
        message.classList.add("message");
        if (isSent) {
          message.classList.add("sent");
        } else {
          message.classList.add("received");
        }
        // Add the message text
        message.innerHTML = `<p>${text}</p>`;
        // Add the current time
        const time = new Date().toLocaleString();
        message.innerHTML += `<p class="time">${time}</p>`;
        // Add the message to the chat container
        chatContainer.appendChild(message);
        // Scroll the chat container to the bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
      } 

      // Listen for the send button to be clicked
      sendButton.addEventListener("click", () => {
        // check if the message input is empty
        if (messageInput.value === "") {
          return;
        }
        // Get the message text
        const text = messageInput.value;
        // Add the message as a sent message
        addMessage(text, true);
        // Clear the message input 
        messageInput.value = "";
        // WAIT FOR BACKEND TO RESPOND
        // TYPING PLACEHOLDER: Create a placeholder element with the typing animation class
        const placeholder = document.createElement("div");
        placeholder.classList.add("message", "received", "typing-animation");
        // add the placeholder to the chat container
        chatContainer.appendChild(placeholder);
        // Scroll the chat container to the bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
        // Send the message to the backend and add the response as a received message
        sendTextToBackend(text).then(data => {
          console.log(data.response.action)
          console.log(data.response.args) 
          const action = data.response.action;
          const args = data.response.args;
          let text = "";
          let parsed_spec = "";
          // check action 
          if(action == "text_response")
          {
            // check if args is not empty
            text = args[0];
          } 
          else if(action == "create_vis")
          {
            // CREATE VISUALIZATION
            text = args[0];  
            const new_vega_lite_spec = args[1];
            const updated_result_table = args[2];
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size
            parsed_spec.width = 500 //"container";
            parsed_spec.height = 150;
            // set the correct data path of the spec -> updated: it delivers the data right away
            //parsed_spec.data = {"name":"weather", "url":"http://localhost:8080/static/ui/pages/web_pages/playgrounds/vegalite_playground/assets/tables/weather.csv"}
            console.log(parsed_spec);
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // turn var into string and then set value of code editor
            //spec = JSON.stringify(parsed_spec, null, 2);
            //codeMirrorEditor.setValue(spec);
            // UPDATE RESULT TABLE
            // get the data-table-container div and set the innerHTML to the updated table
            const result_table_container = document.getElementById("data-table-container");
            result_table_container.innerHTML = updated_result_table;
            // get the table element within the container and add the id 'data-table'
            const result_table = result_table_container.getElementsByTagName("table")[0];
            result_table.id = "data-table";
            // remove the classes of the table
            result_table.classList.remove("dataframe");
            // remove the border attribute of the table
            result_table.removeAttribute("border");
            // get the first row in the table head and remove the style="text-align: right;" attribute
            const first_row = result_table.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];
            first_row.removeAttribute("style");
            // reset the DataTable on the result table
            $('#data-table').DataTable();
          }
          else if(action == "create_vega_lite" || action == "create_vega")
          {
            // CREATE VEGA LITE VISUALIZATION
            text = args[0];   
            const new_vega_lite_spec = args[1]; 
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size 
            parsed_spec.width = 500 //"container";
            parsed_spec.height = 150;
            console.log(parsed_spec);
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // 
          }
          else if(action == "update_vis")
          { 
            // UPDATE VISUALIZATION
            text = args[0];
            const new_vega_lite_spec = args[1];
            console.log(new_vega_lite_spec);
            parsed_spec = JSON.parse(new_vega_lite_spec);
            // set width and height to match container size
            parsed_spec.width = "container";
            parsed_spec.height = 150;
            // re-render the visualization
            vegaEmbed("#plot_content", parsed_spec);
            // turn var into string and then set value of code editor
            spec = JSON.stringify(parsed_spec, null, 2);
            codeMirrorEditor.setValue(spec);
          }
          // FEW SHOT ACTIONS
          else if(action == 'navigate_city')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const city_name = args[1];
            // call the function to navigate to the city page in the mapFrame
            mapFrame.contentWindow.navigateToCity(city_name);
          }
          else if(action == 'locomotion')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const locomotion_type = args[1];
            switch (locomotion_type) {
              case 'in':
                mapFrame.contentWindow.zoomIn();
                break;
              case 'out':
                mapFrame.contentWindow.zoomOut();
                break;
              case 'left':
                mapFrame.contentWindow.panLeft();
                break;
              case 'right':
                mapFrame.contentWindow.panRight();
                break;
              case 'up':
                mapFrame.contentWindow.panUp();
                break;
              case 'down':
                mapFrame.contentWindow.panDown();
                break;
              default:
                text = "Sorry, I don't know how to execute your command yet."
                break;
            }
          }
          else if(action == 'change_map_type')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the string of the city name
            const map_type = args[1];
            // call the change_map type function in iframe
            mapFrame.contentWindow.changeMapType(map_type); 
          }
          else if(action == 'download_visualization')
          {
            // take out the text for the frontend
            text = args[0];
            // call the download function 
            download_visualization_as_image();
          }
          else if(action == 'marker_plot')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the list of lists of lat_lon values for the markers
            const lat_lon_list = args[1];
            // call the create_marker_plot function in the iframe
            mapFrame.contentWindow.create_marker_plot(lat_lon_list);
          }
          else if(action == 'heat_map')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the intensity map for the heatmap
            const intensity_map = args[1];
            // call the create_heat_map function in the iframe
            mapFrame.contentWindow.create_heatmap(intensity_map);
          }
          else if(action == 'flow_map')
          {
            // take out the text for the frontend
            text = args[0];
            // take out the wind_map from the args
            const wind_map = args[1];
            // call the create_flow_map function in the iframe
            mapFrame.contentWindow.create_flow_map(wind_map);
          }
          else if(action == 'reset_map')
          {
            // take out the text for the frontend
            text = args[0];
            // call the reset_map function in the iframe
            mapFrame.contentWindow.reset_map();
          }
          // Add the response as a received message -> outdated -> we use the animation instead
          //addMessage(data.response, false);
          // change placeholder to received message 
          placeholder.classList.remove("typing-animation");
          placeholder.innerHTML = `<p>${text}</p>`;
          // if we have a create vega action, we need to add the code block
          if(action == "create_vega_lite" || action == "create_vega")
          {
              // Add the Vega Lite Code lock 
              edit_button_id = "editButton_"+ Math.random().toString(36).substr(2, 9);
              // jfi: styling the background color of the code works like this: pre style="background-color: #000000"
              vega_lite_spec_string = JSON.stringify(parsed_spec, null, 2);
              placeholder.innerHTML += `
              <div class="message-body" style="padding: 2px;">
                <pre style="background-color: #f5f5f5">
                  <code class="language-javascript" style="font-size: 10px">${vega_lite_spec_string}</code>
                </pre>
                <div class="buttons mt-2">
                  <button class="button is-primary" id="${edit_button_id}" onclick="edit_code(this)">Edit</button>
                </div>
              </div>
              `;
              // in the placeholder find the edit button and add an event listener
              const edit_button = document.getElementById(edit_button_id);
              // add event listener to edit button
              edit_button.addEventListener('click', function() {
                // get the code element within the placeholder
                console.log('edit button clicked');
              });
          }
          // Add the current time
          const time = new Date().toLocaleString();
          placeholder.innerHTML += `<p class="time">${time}</p>`;
          // EVALUATION: 
          const index = evaluation_data.length;
          // Add the index to the message as a data attribute
          placeholder.setAttribute("data-index", index);
          placeholder.innerHTML += `
          </br>
					<div class="likert-scale">
						<label class="label">Please rate this response:</label>
						<label class="radio">
							<input type="radio" name="step-${index}" value="1">
							1
						</label>
						<label class="radio">
							<input type="radio" name="step-${index}" value="2">
							2
						</label>
						<label class="radio">
							<input type="radio" name="step-${index}" value="3">
							3
						</label>
						<label class="radio">
							<input type="radio" name="step-${index}" value="4">
							4
						</label>
						<label class="radio">
							<input type="radio" name="step-${index}" value="5">
							5
						</label>
            </br>
            <!-- text area for users to write feedback -->
            <div class="field">
              <label class="label">Please write your feedback:</label>
              <div class="control">
                <textarea class="textarea" placeholder="Textarea"></textarea>
              </div>
            </div>
					</div>
          `;
          // get user turn = get the message of the user before the bot response
        const previous_message = placeholder.previousElementSibling;
        // get the text of the previous message which is the content of the p element
        const user_turn = previous_message.querySelector('p').textContent;
          // Add the message data to the array
          evaluation_data.push({
            chat_uuid: chat_uuid,
            index: index,
            rating: null,
            feedback: "", 
            task: current_task,
            user_turn: user_turn
          });
          // END OF EVALUATION
          // Scroll the chat container to the bottom
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      });
      // add initial message to the chat
      addMessage("Hello, I am VIST5. As a specialized visualization chatbot, I can generate visualizations from natural language descriptions, allow modifications based on your requirements, and answer any questions you may have related to your visualization.", false);

      // SEND INPUT TO BACKEND 
      async function sendTextToBackend(text) {
        try {
          const response = await fetch(`${host_url}/perceive_text`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
          });

          if(!response.ok){
            throw new Error(response.statusText)
          }
          const data = await response.json(); // data format: {response: "text"}
          return data;
        } catch (error) {
          console.error("Error:", error);
          throw error
        }
      }
      // CHAT LOGIC: END

      // EVALUATION LOGIC: START
      // Initialize the evaluation_data array
      let evaluation_data = [];
      // create a unique has for the user 
      const chat_uuid = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

      // Function to handle the rating change
      function handleRatingChange(event) {
        const index = event.target.closest(".message").dataset.index;
        const rating = event.target.value;
        // Update the message data in the array
        evaluation_data[index].rating = rating;
        console.log(evaluation_data);
      }

      // Function to handle the feedback change
      function handleFeedbackChange(event) {
        const index = event.target.closest(".message").dataset.index;
        const feedback = event.target.value;
        // Update the message data in the array
        evaluation_data[index].feedback = feedback;
        console.log(evaluation_data);
      }

      // Attach event listeners to the likert scales and feedback textareas
      chatContainer.addEventListener("change", function(event) {
        if (event.target.matches(".likert-scale input[type=radio]")) {
          handleRatingChange(event);
        }
      });

      chatContainer.addEventListener("input", function(event) {
        if (event.target.matches(".textarea")) {
          handleFeedbackChange(event);
        }
      });
      
      //// login in and out from the backend
      // Send a request to the backend to add the user to the list of connected users
      async function connectToSystem() {
        const response = await fetch('/connect', { method: 'POST' });
        const data = await response.json();
        console.log('... connected to system ...');
        console.log(data);
      }

      // Send a request to the backend to remove the user from the list of connected users
      async function disconnectFromSystem() {
        await fetch('/disconnect', { method: 'POST' });
      }

      // Call the connectToSystem function when the page is loaded
      window.addEventListener('load', connectToSystem);

      // Call the disconnectFromSystem function when the page is closed
      window.addEventListener('beforeunload', disconnectFromSystem);

      //// MODALS
      // Study Start Modal
      const closeStudyStartModalButton = document.getElementById('close-start-modal');
      const cancelStudyStartModalButton = document.getElementById('cancel-start-modal');
      const startStudyButton = document.getElementById('start-study-button');
      const startModal = document.getElementById('study-start-modal');

      closeStudyStartModalButton.addEventListener('click', () => {
        startModal.classList.remove('is-active');
        // reload the page
        location.reload();
      });

      cancelStudyStartModalButton.addEventListener('click', () => {
        startModal.classList.remove('is-active');
        // reload the page
        location.reload();
      });

      startStudyButton.addEventListener('click', () => {
        startModal.classList.remove('is-active');
        console.log("... starting user study ...");
      });

      // when the document is ready, click the open study start modal button
      $(document).ready(function() {
        startModal.classList.add('is-active');
      });

      // Study Finish Modal
      const openStudyFinishModalButton = document.getElementById('open-finish-modal');
      const closeStudyFinishModalButton = document.getElementById('close-finish-modal');
      const cancelStudyFinishModalButton = document.getElementById('cancel-finish-modal');
      const finishStudyButton = document.getElementById('finish-study-button');
      const finishModal = document.getElementById('study-finish-modal');

      openStudyFinishModalButton.addEventListener('click', () => {
        finishModal.classList.add('is-active');
      });
 
      closeStudyFinishModalButton.addEventListener('click', () => {
        finishModal.classList.remove('is-active');
      });

      cancelStudyFinishModalButton.addEventListener('click', () => {
        finishModal.classList.remove('is-active');
      });

      const minimum_number_of_turns_to_evaluate = 3;

      //// study metadata + event listeners for every property
      let user_study_data_object = {
        "gender":"",
        "age_group":"",
        "profession":"",
        "experience":"",
        "turns":[]
      }

      const gender_radios = document.querySelectorAll('input[type="radio"][name="gender"]');
      gender_radios.forEach(radio => {
          radio.addEventListener('change', () => {
            console.log(radio.value);
            // set the updated value in the study_metadata object
            user_study_data_object.gender = radio.value;
          });
        });

        const age_group_radios = document.querySelectorAll('input[type="radio"][name="age_group"]');
        age_group_radios.forEach(radio => {
          radio.addEventListener('change', () => {
            console.log(radio.value);
            // set the updated value in the study_metadata object
            user_study_data_object.age_group = radio.value;
          });
        });

        const profession_radios = document.querySelectorAll('input[type="radio"][name="profession"]');
        profession_radios.forEach(radio => {
          radio.addEventListener('change', () => {
            console.log(radio.value);
            // set the updated value in the study_metadata object
            user_study_data_object.profession = radio.value;
          });
        });

        const experience_radios = document.querySelectorAll('input[type="radio"][name="experience"]');
        experience_radios.forEach(radio => {
          radio.addEventListener('change', () => {
            console.log(radio.value);
            // set the updated value in the study_metadata object
            user_study_data_object.experience = radio.value;
          });
        });

      finishStudyButton.addEventListener('click', () => {
        // check if evaluation_data is empty
        if (evaluation_data.length < minimum_number_of_turns_to_evaluate) {
          alert("Please evaluate at least "  + minimum_number_of_turns_to_evaluate + " turns before finishing the study!\nYou have evaluated " + evaluation_data.length + " turns so far.");
          return;
        }
        // send a request to the backend to finish the study
        finishStudyBackend().then(response => {
          console.log(response);
        });
        // send the user to the thank you page
        //window.location.href = `${host_url}/thank_you`;
      });

      function finishStudyBackend() {
        // set the evaluation_data list in the study_metadata object
        user_study_data_object.turns = evaluation_data;
        // Convert the evaluation_data list to JSON
        const jsonData = JSON.stringify(user_study_data_object);
         // send the evaluation_data list to the backend at localhost:8080/user_study_result 
        fetch('/user_study_result', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: jsonData 
        })
        .then(response => {
          console.log('Response:', response);
          // redirect to the thank you page
          window.location.href = `${host_url}/thank_you`;
        })
        .catch(error => {
          console.error('Error:', error);
        });
      } 
      // EVALUATION LOGIC: END

      // EVALUATION TASK SETUP: START
      // get all 3 task list items, there ids are task-1, task-2 and task-3
      const task1 = document.getElementById('task-1');
      const task2 = document.getElementById('task-2');
      const task3 = document.getElementById('task-3');
      const task4 = document.getElementById('task-4');
      // task pool is an array of strings that contain task descriptions 
      const zero_shot_task_pool = [
        'Retrieve a value that you are interested in, e.g., retrieve the number of data records existing in the dataset for a city of your choice.', // temperature in Berlin on the 1st of January 2010.
        'Filter the dataset for a specific condition, e.g., show a chart (e.g. temperature) in a location of your choice filtered for the year 2010 only.',
        'Compute a derived value, e.g., get the mean temperature per month in a city of your choice.',
        'Find an extremum, e.g., find the maximum temperatures per month in a city of your choice.',
        'Sort retrieved values, e.g., get a bar chart of the mean temperature per city and sort them in ascending/descending order to find out, which city has the highest/lowest mean temperature.',
        'Determine the range of a column, e.g., get the range of the temperature values in the datset.',
        'Characterize the distribution of a value, e.g., get a histogram of the temperature values in the datset in a location of your choice.',
        'Find anomalies, e.g., create a temperature chart over time for a city of your choice and find out if there are any extrema in the temperature curve.',
        'Find similarities, e.g., create a temperature chart over time for all cities and find out if there are any similarities in the temperature curves.',
        'Correlate two columns, e.g., find out how temperature and humidity are correlated in the datset.' 
       ]
       const few_shot_task_pool = [
        //'Create a leaflet heatmap by saying something like: give me a leaflet heatmap of the column temperature/humidity/pressure',
        //'Create a leaflet marker plot by saying something like: give me a leaflet marker plot of all cities in the dataset', 
        //'Create a flow map by saying something like: give me leaflet flow map of the column wind_direction (only possible for northern_european_cities.csv)',
        'Ask the chatbot to zoom in/zoom out/move left/move right/move up/move down',
        'Ask the chatbot to navigate to a city of the chosen dataset, e.g. navigate to London.',
        //'Ask the chatbot to download the visualization.', 
        //'Ask the chatbot to change the map type to satellite/street/dark/hybrid.'
       ]
       // get 3 random tasks from the task pool and add the strings to the message-body divs of the task list items
        const task_1_index = Math.floor(Math.random() * zero_shot_task_pool.length);
        task1.querySelector('.message-body').innerHTML = zero_shot_task_pool[task_1_index];
        // remove the task from the task pool so that it is not repeated
        zero_shot_task_pool.splice(task_1_index, 1);
        // compute the index of the second task
        const task_2_index = Math.floor(Math.random() * zero_shot_task_pool.length);
        task2.querySelector('.message-body').innerHTML = zero_shot_task_pool[task_2_index];
        // remove the task from the task pool so that it is not repeated
        zero_shot_task_pool.splice(task_2_index, 1);
        // flip a coin -> if > 0.75 we sample a few shot task, else we sample a zero shot task
        //if (Math.random() > 0.25) { 
        task3.querySelector('.message-body').innerHTML = few_shot_task_pool[Math.floor(Math.random() * few_shot_task_pool.length)];
        //} else {
        //  task3.querySelector('.message-body').innerHTML = zero_shot_task_pool[Math.floor(Math.random() * zero_shot_task_pool.length)];
        //}
        // few shot task selection
        //task3.querySelector('.message-body').innerHTML = few_shot_task_pool[Math.floor(Math.random() * few_shot_task_pool.length)];
        // Amar et al tasks
        // 1. retrieve value: General Description: Given a set of specific cases, find attribute sof those cases
        // 2. filter: Given some concrete conditions on attribute values, find data cases satisfying those conditions. 
        // 3. compute derived value: Given a set of data cases, compute an aggregate numeric representation of those data cases. -> AVG/mean, sum, count, 
        // 4. find extremum:  Find data cases possessing an extreme value of an attribute over its range within the data set. -> min, max, 
        // 5. sort: Given a set of data cases, rank them according to some ordinal metric-> ascending, descending
        // 6. determine range: Determine Range  -> determine 
        // 7. characterize distribution: Given a set of data cases and a quantitative attribute of interest, characterize the distribution of that attribute’s values over the set -> histogram 
        // 8. find anomalies:  Identify any anomalies within a given set of data cases with respect to a given relationship or expectation, e.g. statistical outliers. 
        // 9. cluster: Given a set of data cases, find clusters of similar attribute values. 
        // 10. correlate: Given a set of data cases and two attributes, determine useful relationships between the values of those attributes

        //// CURRENT TASK LOGGING
        let current_task = task1.querySelector('.message-body').innerHTML 
        const task_elements = [task1, task2, task3, task4]
        // add onclick function to every task element in the task list and change the class from is-dark to is-primary
         task_elements.forEach(function(task_element, index) {
          task_element.addEventListener('click', () => {
            // get the child element of the task element that is an article element
            const article_element = task_element.querySelector('article');
            // check if the article element has the class is-dark
            if (article_element.classList.contains('is-dark')) {
              // change the class of the article element from is-dark to is-primary
              article_element.classList.remove('is-dark'); 
              article_element.classList.add('is-primary');
              // get the text of the task element which is in the message-body div
              const task_text = task_element.querySelector('.message-body').innerHTML;
              // put the text into <s> tags
              const task_text_styled = '<s>' + task_text + '</s>';
              task_element.querySelector('.message-body').innerHTML = task_text_styled;
              // update the current task to be the text of the task_element with the index+1 if index < 3, else index = 3
              // get the min_index of the index and 3
              const min_index = Math.min(index+1, 3);
              current_task = task_elements[min_index].querySelector('.message-body').innerHTML;
            }
            else if(article_element.classList.contains('is-primary')) {
              // change the class of the article element from is-primary to is-dark
              article_element.classList.remove('is-primary');
              article_element.classList.add('is-dark');
              // get the text of the task element which is in the message-body div
              const task_text = task_element.querySelector('.message-body').innerHTML;
              // remove the <s> tags
              const task_text_styled = task_text.replace('<s>', '').replace('</s>', '');
              task_element.querySelector('.message-body').innerHTML = task_text_styled;
              // update the current task to be the the text of the task_element with my index
              current_task = task_elements[index].querySelector('.message-body').innerHTML;
            }
            //console log the current task
            console.log(current_task);
        });
      }); 
      // EVALUATION TASK SETUP: END

      // CUSTOM FUNCTIONS
      async function download_visualization_as_image() {
        const dom_element = document.getElementsByClassName('marks')[0]; // chart-wrapper
        domtoimage.toJpeg(dom_element, { quality: 0.99 })
        .then(function (dataUrl) {
            var link = document.createElement('a');
            link.download = 'export_plot.jpg';
            link.href = dataUrl;
            link.click();
        });
      }
      // call download_visualization_as_image 2 functions after site is loaded
      //setTimeout(download_visualization_as_image, 3000);

      function test_logg(myoutput)
      {
        console.log(myoutput);
      }

      // FUNCTION EVALUATOR: gets as input a string and evaluates it as a function, solution found here: https://stackoverflow.com/questions/6479236/calculate-string-value-in-javascript-not-using-eval
      function function_evaluator(function_string) {
        // try to evaluate the function
        try {
          // evaluate the function
          var function_to_evaluate = new Function('return ' + function_string)();
          // call the function
          function_to_evaluate();
        } catch (e) {
          // if the function could not be evaluated, log the error
          console.log(e);
          // update the chat with the error message
          const error_message = "Sorry, an error occured while executing your command. Please try again.";
          addMessage(error_message, false);
        }
        // OLD SOLUTION: 
        //return new Function('return ' + function_string)();
      }
      //function_evaluator('zoom_browser_in(50)'); //function_evaluator('test_logg("this is a very long test text")');
      // CUSTOM FUNCTIONS: END

    </script>
</body>
</html>

